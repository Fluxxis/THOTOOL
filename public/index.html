<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Username Finder</title>
  <style>
    :root{
      --bg:#000;
      --fg:#fff;
      --muted: rgba(255,255,255,.72);
      --muted2: rgba(255,255,255,.55);
      --soft: rgba(255,255,255,.12);
      --soft2: rgba(255,255,255,.20);
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      background: var(--bg);
      color: var(--fg);
      font-family: var(--mono);
      overflow-x:hidden;
    }

    /* subtle monochrome motion */
    .bgNoise{
      position:fixed; inset:0; pointer-events:none; z-index:0;
      opacity:.18;
      background:
        repeating-linear-gradient(to bottom, rgba(255,255,255,.05) 0px, rgba(255,255,255,.05) 1px, transparent 2px, transparent 6px);
      animation: scan 7s linear infinite;
    }
    @keyframes scan{0%{transform:translateY(0)}100%{transform:translateY(24px)}}

    .wrap{
      position:relative;
      z-index:1;
      max-width: 980px;
      margin: 0 auto;
      padding: 18px 14px 44px;
      display:flex;
      flex-direction:column;
      min-height:100%;
      gap:14px;
    }

    /* 5s intro loading */
    .intro{
      position:fixed; inset:0;
      display:flex; align-items:center; justify-content:center;
      background:#000;
      z-index:50;
      flex-direction:column;
      gap:14px;
      animation: introOut .3s ease-out forwards;
      animation-delay: 5s;
    }
    @keyframes introOut{
      to{opacity:0; visibility:hidden}
    }
    .intro img{
      width: 140px; height: 140px;
      filter: grayscale(1) contrast(1.15);
      opacity:.95;
    }
    .intro .t{
      font-size: 12px;
      color: var(--muted);
      letter-spacing: .4px;
      text-transform: uppercase;
      animation: flicker 1.4s infinite steps(2,end);
    }
    @keyframes flicker{0%,49%{opacity:1}50%,100%{opacity:.5}}

    /* Main menu */
    .menu{
      margin-top: 0;
      display:flex;
      flex-direction:column;
      gap: 16px;
      align-items:center;
      justify-content:center;
      padding-top: 10px;
    }
    .brand{
      text-align:center;
      margin-top: 2px;
    }
    .brand .h{
      font-size: 18px;
      letter-spacing: 1px;
      text-transform: uppercase;
      margin:0;
    }
    .brand .s{
      margin-top:6px;
      font-size: 12px;
      color: var(--muted2);
      line-height: 1.4;
      max-width: 720px;
    }

    .centerBox{
      width: min(520px, 100%);
      display:flex;
      flex-direction:column;
      gap: 12px;
      align-items:stretch;
      margin-top: 6px;
    }

    .inputRow{
      display:flex;
      gap: 10px;
      align-items:stretch;
      flex-wrap:wrap;
      justify-content:center;
    }

    .nickInput{
      flex: 1 1 260px;
      background:#000;
      color:#fff;
      border: 1px solid rgba(255,255,255,.25);
      padding: 12px 12px;
      font-family: var(--mono);
      font-size: 13px;
      outline:none;
      transition: border-color .15s ease;
    }
    .nickInput:focus{
      border-color: rgba(255,255,255,.70);
    }

    .btn{
      padding: 12px 14px;
      font-family: var(--mono);
      font-size: 13px;
      cursor:pointer;
      border: 1px solid #fff;
      background:#fff;
      color:#000;
      transition: transform .1s ease, opacity .1s ease;
      user-select:none;
      flex: 0 0 auto;
      min-width: 120px;
    }
    .btn:active{transform: translateY(1px)}
    .btn:disabled{opacity:.5; cursor:not-allowed}
    .btn.secondary{
      background:#000;
      color:#fff;
      border: 1px solid rgba(255,255,255,.35);
      min-width: 160px;
    }

    .actions{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      justify-content:center;
    }

    /* Terminal logs */
    .terminal{
      width: 100%;
      border: 1px solid rgba(255,255,255,.20);
      padding: 12px;
      margin-top: 10px;
      max-height: 44vh;
      overflow:auto;
      font-size: 12px;
      line-height: 1.45;
      white-space: pre-wrap;
      color: rgba(255,255,255,.86);
    }
    .logMuted{color: rgba(255,255,255,.55)}
    .logOk{color: rgba(255,255,255,.95)}
    .logNo{color: rgba(255,255,255,.55)}
    .logErr{color: rgba(255,255,255,.50); text-decoration: underline dotted rgba(255,255,255,.25);}

    /* Found modal */
    .modal{
      position:fixed; inset:0;
      display:none;
      align-items:center;
      justify-content:center;
      padding: 18px 14px;
      background: rgba(0,0,0,.82);
      z-index:60;
    }
    .modal.open{display:flex}
    .modalBox{
      width: min(720px, 100%);
      background:#000;
      border: 1px solid rgba(255,255,255,.25);
      padding: 14px;
      max-height: 80vh;
      overflow:auto;
    }
    .modalTop{
      display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap;
      margin-bottom: 10px;
    }
    .modalTitle{
      font-size: 13px;
      letter-spacing: .6px;
      text-transform: uppercase;
      color: rgba(255,255,255,.88);
    }
    .foundList{
      display:grid;
      grid-template-columns: 1fr;
      gap: 10px;
    }
    @media (min-width: 760px){
      .foundList{grid-template-columns: 1fr 1fr;}
    }
    .foundItem{
      border: 1px solid rgba(255,255,255,.18);
      padding: 10px;
      display:flex;
      flex-direction:column;
      gap: 6px;
    }
    .foundItem .name{
      font-size: 12px;
      color: rgba(255,255,255,.88);
      text-transform: uppercase;
      letter-spacing: .4px;
    }
    .foundItem a{
      color: #fff;
      text-decoration: underline;
      text-underline-offset: 3px;
      font-size: 12px;
      overflow-wrap:anywhere;
      opacity:.9;
    }
    .foundItem a:hover{opacity:1}

    /* Status line */
    .status{
      text-align:center;
      font-size: 12px;
      color: rgba(255,255,255,.70);
      min-height: 18px;
      margin-top: 6px;
    }

    .footer{
      margin-top:auto;
      text-align:center;
      font-size: 11px;
      color: rgba(255,255,255,.38);
      padding-top: 10px;
    }
  </style>
</head>
<body>
  <div class="bgNoise"></div>

  <!-- 5 seconds intro -->
  <div class="intro" id="intro" aria-hidden="false">
    <img src="./loading.gif" alt="loading">
    <div class="t">loading...</div>
  </div>

  <!-- Found modal -->
  <div class="modal" id="modal">
    <div class="modalBox">
      <div class="modalTop">
        <div class="modalTitle" id="modalTitle">Найдено</div>
        <div class="actions">
          <button class="btn secondary" id="btnMainMenu">Главное меню</button>
          <button class="btn" id="btnDownload" disabled>Скачать HTML</button>
        </div>
      </div>
      <div class="foundList" id="foundList"></div>
      <div class="status" id="modalStatus"></div>
    </div>
  </div>

  <div class="wrap">
    <div class="menu" id="menu">
      <div class="brand">
        <p class="h">Username Finder</p>
        <div class="s">Вводишь ник — получаешь найденные публичные страницы. Статус HTTP не гарантирует существование профиля, но помогает быстро отсеять мусор.</div>
      </div>

      <div class="centerBox">
        <div class="inputRow">
          <input class="nickInput" id="username" placeholder="ник (2..64)" autocomplete="off" />
          <button class="btn" id="btnSearch">Поиск</button>
        </div>

        <div class="status" id="statusLine">Готов.</div>

        <div class="terminal" id="terminal" aria-live="polite"></div>

        <div class="actions" style="margin-top:6px">
          <button class="btn secondary" id="btnClear">Очистить логи</button>
        </div>
      </div>
    </div>

    <div class="footer">© local tool. соблюдай правила сайтов.</div>
  </div>

<script>
  const $ = (id) => document.getElementById(id);

  const intro = $("intro");
  const btnSearch = $("btnSearch");
  const btnClear = $("btnClear");
  const statusLine = $("statusLine");
  const terminal = $("terminal");

  const modal = $("modal");
  const foundList = $("foundList");
  const modalTitle = $("modalTitle");
  const modalStatus = $("modalStatus");
  const btnMainMenu = $("btnMainMenu");
  const btnDownload = $("btnDownload");

  let last = { username: null, total: 0, results: [], found: [] };

  function esc(s){
    return (s||"").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;");
  }

  function log(line, cls=""){
    const ts = new Date().toLocaleTimeString();
    const span = document.createElement("div");
    span.className = cls;
    span.textContent = `[${ts}] ${line}`;
    terminal.appendChild(span);
    terminal.scrollTop = terminal.scrollHeight;
  }

  function clearLogs(){
    terminal.innerHTML = "";
    log("logs cleared.", "logMuted");
  }

  btnClear.addEventListener("click", clearLogs);

  async function api(url, tries=3){
    let lastErr = null;
    for (let i=0; i<tries; i++){
      try{
        const res = await fetch(url, { cache:"no-store" });
        const data = await res.json();
        if (!res.ok) throw new Error(data.error || "API error");
        return data;
      }catch(e){
        lastErr = e;
        await new Promise(r => setTimeout(r, 400 + i*600));
      }
    }
    throw lastErr;
  }

  function setBusy(on){
    btnSearch.disabled = on;
    if (on){
      statusLine.textContent = "Ищу данные…";
    }
  }

  function openModal(){
    modal.classList.add("open");
  }
  function closeModal(){
    modal.classList.remove("open");
  }

  btnMainMenu.addEventListener("click", () => {
    closeModal();
    statusLine.textContent = "Готов.";
  });

  function buildFound(results){
    // "maybe" is our only safe heuristic. We'll present these as found.
    const found = results.filter(r => r.verdict === "maybe").map(r => ({
      name: r.name,
      url: (r.finalUrl || r.url),
      kind: r.kind,
      status: r.status
    }));
    // Deduplicate by URL
    const seen = new Set();
    const uniq = [];
    for (const f of found){
      if (seen.has(f.url)) continue;
      seen.add(f.url);
      uniq.push(f);
    }
    return uniq;
  }

  function renderFound(){
    foundList.innerHTML = "";
    if (!last.found.length){
      foundList.innerHTML = `<div class="foundItem"><div class="name">Ничего не найдено</div><div class="logMuted">Попробуй другой ник или проверь вручную.</div></div>`;
      return;
    }
    for (const item of last.found){
      const div = document.createElement("div");
      div.className = "foundItem";
      div.innerHTML = `<div class="name">${esc(item.name)}</div>
                       <a href="${esc(item.url)}" target="_blank" rel="noreferrer">${esc(item.url)}</a>`;
      foundList.appendChild(div);
    }
  }

  function buildReportHTML(){
    const username = last.username;
    const now = new Date().toISOString();
    const found = last.found;

    const cards = found.map(f => `
      <div class="card">
        <div class="name">${esc(f.name)}</div>
        <a href="${esc(f.url)}">${esc(f.url)}</a>
      </div>
    `).join("");

    return `<!doctype html>
<html lang="ru"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>Report: ${esc(username)}</title>
<style>
  body{margin:0;background:#000;color:#fff;font-family:ui-monospace,Menlo,Consolas,monospace;padding:22px}
  h1{font-size:16px;letter-spacing:1px;text-transform:uppercase;margin:0}
  .meta{margin-top:8px;color:rgba(255,255,255,.68);font-size:12px;line-height:1.45}
  .grid{margin-top:14px;display:grid;grid-template-columns:1fr;gap:10px}
  @media(min-width:760px){.grid{grid-template-columns:1fr 1fr}}
  .card{border:1px solid rgba(255,255,255,.22);padding:12px}
  .name{font-size:12px;letter-spacing:.5px;text-transform:uppercase;color:rgba(255,255,255,.88);margin-bottom:6px}
  a{color:#fff;text-decoration:underline;text-underline-offset:3px;word-break:break-word;opacity:.9}
  a:hover{opacity:1}
  .footer{margin-top:18px;color:rgba(255,255,255,.65);font-size:12px}
</style></head>
<body>
  <h1>Username Finder Report</h1>
  <div class="meta">username: <b>${esc(username)}</b><br>generated: ${esc(now)}<br>found: ${found.length}</div>
  <div class="grid">${cards || '<div class="card"><div class="name">Ничего не найдено</div><div class="meta">Нет ссылок с вердиктом "возможно".</div></div>'}</div>
  <div class="footer">спасибо за поддержку</div>
</body></html>`;
  }

  btnDownload.addEventListener("click", () => {
    if (!last.username) return;
    const html = buildReportHTML();
    const blob = new Blob([html], {type:"text/html;charset=utf-8"});
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = `report-${last.username}.html`;
    a.click();
    URL.revokeObjectURL(a.href);
    modalStatus.textContent = "Файл скачан.";
  });

  async function run(){
    const username = $("username").value.trim();
    if (username.length < 2 || username.length > 64){
      statusLine.textContent = "Ник должен быть 2..64 символа.";
      return;
    }

    // Wait for intro to finish if it's still visible (exactly 5s from load)
    // Not blocking user; just ensure UI is ready.
    setBusy(true);
    btnDownload.disabled = true;
    modalStatus.textContent = "";
    clearLogs();
    log(`start scan for "${username}"`, "logOk");

    last = { username, total: 0, results: [], found: [] };

    const pageSize = 60;
    const concurrency = 8;

    const t0 = performance.now();
    try{
      const first = await api(`/api/check?username=${encodeURIComponent(username)}&offset=0&page_size=${pageSize}&concurrency=${concurrency}`, 3);
      last.total = first.total;
      last.results.push(...first.results);

      log(`batch 1: ${first.results.length} / total ${last.total}`, "logMuted");

      let done = last.results.length;
      statusLine.textContent = `Проверено ${done}/${last.total}…`;

      for (let offset = pageSize; offset < last.total; offset += pageSize){
        const data = await api(`/api/check?username=${encodeURIComponent(username)}&offset=${offset}&page_size=${pageSize}&concurrency=${concurrency}`, 3);
        last.results.push(...data.results);
        done = last.results.length;
        log(`batch ${(offset/pageSize)+1}: +${data.results.length} => ${done}/${last.total}`, "logMuted");
        statusLine.textContent = `Проверено ${done}/${last.total}…`;
        await new Promise(r => setTimeout(r, 220));
      }

      // Summarize logs: count maybe/no/unknown/error
      const counts = { maybe:0, no:0, unknown:0, error:0 };
      for (const r of last.results){
        counts[r.verdict] = (counts[r.verdict] || 0) + 1;
      }
      log(`summary: maybe=${counts.maybe||0} no=${counts.no||0} unknown=${counts.unknown||0} error=${counts.error||0}`, "logOk");

      last.found = buildFound(last.results);
      log(`found links: ${last.found.length}`, "logOk");

      const t1 = performance.now();
      statusLine.textContent = `Готово за ${((t1-t0)/1000).toFixed(2)}s. Найдено: ${last.found.length}.`;

      // Open results modal
      modalTitle.textContent = `Найдено: ${last.found.length}`;
      renderFound();
      btnDownload.disabled = false;
      openModal();
    }catch(e){
      log("network error / rate limit / blocked by site.", "logErr");
      statusLine.textContent = "Сбой сети. Часть сайтов могла блокировать запросы. Повтори или уменьши параллельность.";
    }finally{
      setBusy(false);
    }
  }

  btnSearch.addEventListener("click", run);
  $("username").addEventListener("keydown", (e) => {
    if (e.key === "Enter") run();
  });

  // ensure intro is exactly 5s on first load; after that it is gone
  window.addEventListener("load", () => {
    // terminal initial
    clearLogs();
    statusLine.textContent = "Готов.";
    setTimeout(() => {
      intro.style.display = "none";
    }, 5100);
  });
</script>
</body>
</html>